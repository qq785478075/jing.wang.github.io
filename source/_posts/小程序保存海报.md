---
title: 小程序保存海报
tags: [微信小程序]
categories: [微信小程序]
date: 2019-10-08
comments: false
---
微信小程序实现用户选择图片实现保存海报功能
<!-- more -->

***.wxml
```html
  <view class='friend-layer2'>
    <view class='invitation_method'>邀请方式2：</view>
    <view class='poster_box'>
      <view class='poster_img_box'>
        <view class="page-section page-section-spacing swiper">
          <swiper current='{{currentInd}}' skip-hidden-item-layout="true" indicator-dots="true" circular="true" indicator-color="#E7EAED" indicator-active-color="#FF9310" bindchange="imgChange">
            <block wx:for="{{background}}" wx:key="project_type">
              <swiper-item>
                <view class="swiper-item">
                  <image src='{{item.image_server_path}}' class="bj"></image>
                  <image src="{{QRCode}}" class="QRCode"></image>
                </view>
              </swiper-item>
            </block>
          </swiper>
        </view>
      </view>
      <button class='sava_btn' size='mini' bindtap='saveImage'>保存海报</button>
    </view>
  </view>
  <view class="myCanvas">
    <canvas class="myCanvas" canvas-id="myCanvas" style="width: 750rpx; height: 1334rpx;"></canvas>
  </view>
  ```

  ***.wxss
  ```html
.friend-layer2 {
  padding: 30rpx 40rpx;
  box-sizing: border-box;
  position: relative;
}

.friend-layer2  .poster_box {
  width: 100%;
  height: 820rpx;
  background: rgba(255, 255, 255, 1);
  border-radius: 12rpx;
  margin-top: 30rpx;
  padding: 0rpx 30rpx;
  box-sizing: border-box;
  overflow: hidden;
}

.friend-layer2  .poster_box .title {
  font-size: 24rpx;
  font-family: PingFangSC-Regular;
  font-weight: 400;
  color: #333;
  padding: 40rpx 0rpx;
}

.friend-layer2  .poster_box .poster_img_box {
  width: 325rpx;
  height: 562rpx;
  margin: auto;
  position: relative;
}

.friend-layer2  .poster_box .poster_img_box .poster_img_bg {
  width: 325rpx;
  height: 562rpx;
  overflow: hidden;
}

.friend-layer2  .poster_box .poster_img_box .poster_img_bg image {
  display: block;
  width: 100%;
  height: 100%;
}

.friend-layer2  .poster_box  .swiper {
  position: absolute;
  width: 309rpx;
  height: 546rpx;
  top: 8rpx;
  left: 8rpx;
}

.friend-layer2  .poster_box  swiper {
  width: 100%;
  height: 100%;
  /* overflow: hidden; */
}

.friend-layer2  .poster_box  swiper .swiper-item {
  width: 100%;
  height: 100%;
}

.friend-layer2  .poster_box  swiper .swiper-item .bj {
  display: block;
  width: 100%;
  height: 100%;
}

.friend-layer2  .poster_box  swiper .swiper-item .QRCode {
  position: absolute;
  width: 80rpx;
  height: 80rpx;
  display: block;
  bottom: 55rpx;
  right: 112rpx;
}

.friend-layer2  .poster_box .sava_btn {
  position: relative;
  left: 50%;
  transform: translateX(-50%);
  margin-top: 40rpx;
}

.myCanvas {
  position: absolute;
  left: -1000px;
}

.sava_btn {
  background: #ff9310;
  color: #fff;
}

```

****.js
```html
  data: {
    background: [],
    QRCode: '', //二维码
    HeadImg: '', //用户头像
    currentInd: 0, //海报默认选中下标
    hasSave: false,
  },
    //获取图片
  getImage: function() {
    request.wxCheckSess().then(res => {
      let url = rurl.serviceAdd + 'freelancer/load-qr-code-and-poster-path';
      let data = {
        project_type: 0
      }
      request.$http(url, data, 'GET').then(res => {
        if (res && res.code == 1000 && res.data) {
          this.setData({
            background: res.data.posterPath,
            QRCode: 'data:image/jpeg;base64,' + res.data.base64, //二维码
            HeadImg: 'data:image/jpeg;base64,' + res.data.headerBase64
          })
        }
      })
    }).catch()
  },
  //设置海报二维码、头像宽高
  setImageWidth() {
    let currentInd = this.data.currentInd; //海报选中下标
    let posterObj = this.data.background[currentInd]; //选中海报
    //二维码位置、大小
    let image_x = parseFloat(posterObj.image_x) / 2 * multiple;
    let image_y = parseFloat(posterObj.image_y) / 2 * multiple;
    let width = parseFloat(posterObj.width) / 2 * multiple;
    let height = parseFloat(posterObj.height) / 2 * multiple;

    //头像位置、大小
    let header_image_x = parseFloat(posterObj.header_image_x) / 2 * multiple;
    let header_image_y = parseFloat(posterObj.header_image_y) / 2 * multiple;
    let header_width = parseFloat(posterObj.header_width) / 2 * multiple;
    let header_height = parseFloat(posterObj.header_height) / 2 * multiple;

    //canvas画圆头像半径 、位置 
    let circle_r = header_height / 2;
    let circle_x = header_image_x + circle_r;
    let circle_y = header_image_y + circle_r;
  },
  //海报选中改变了
  imgChange: function(e) {
    let currentInd = e.detail.current;
    this.setData({
      currentInd: currentInd
    });
  },
  //海报保存
  saveImage: function() {
    wx.showLoading({
      title: '保存中...',
      mask: true
    })
    if (this.data.hasSave) {
      wx.showToast({
        title: '请稍后...',
        icon: 'none',
        duration: 2000,
        mask: true
      })
      return
    }
    this.setData({
      hasSave: true
    })

    wx.getSetting({
      success: res => {
        console.log(res)
        console.log(res.authSetting['scope.writePhotosAlbum'], !res.authSetting['scope.writePhotosAlbum'])
        if (res.authSetting['scope.writePhotosAlbum'] == undefined) {
          console.log(1)
          this.save()
        } else if (res.authSetting['scope.writePhotosAlbum'] == false) {
          console.log(2)
          wx.openSetting({
            "scope.writePhotosAlbum": true
          })
        } else {
          console.log(3)
          this.save()
        }

      }
    })



  },
  save: function() {
    // 保存到本地
    const canvas = wx.createCanvasContext('myCanvas');
    let currentInd = this.data.currentInd; //海报选中下标
    let posterObj = this.data.background[currentInd]; //选中海报
    let _this = this;

    if (posterObj) {
      let BjImg = posterObj.image_server_path;
      let QRCode = this.data.QRCode;
      let HeadImg = this.data.HeadImg;
      let multiple = getRatio(); //获取手机屏幕基于苹果7（375px） 的倍数
      console.log(multiple)

      //二维码位置、大小
      let image_x = parseFloat(posterObj.image_x) / 2 * multiple;
      let image_y = parseFloat(posterObj.image_y) / 2 * multiple;
      let width = parseFloat(posterObj.width) / 2 * multiple;
      let height = parseFloat(posterObj.height) / 2 * multiple;

      //头像位置、大小
      let header_image_x = parseFloat(posterObj.header_image_x) / 2 * multiple;
      let header_image_y = parseFloat(posterObj.header_image_y) / 2 * multiple;
      let header_width = parseFloat(posterObj.header_width) / 2 * multiple;
      let header_height = parseFloat(posterObj.header_height) / 2 * multiple;

      //canvas画圆头像半径 、位置 
      let circle_r = header_height / 2;
      let circle_x = header_image_x + circle_r;
      let circle_y = header_image_y + circle_r;

      //缓存海报背景
      wx.getImageInfo({
        src: BjImg,
        success: function(res) {

          //canvas 绘制海报背景
          canvas.drawImage(res.path, 0, 0, res.width / 2 * multiple, res.height / 2 * multiple);
          //canvas 绘制图片 不支持 base64 图片
          //把base64  转换成 图片路径
          base64src(QRCode, res => {

            //缓存二维码
            wx.getImageInfo({
              src: res,
              success: function(data) {

                canvas.drawImage(data.path, image_x, image_y, width, height);

                //缓存用户头像
                base64src(HeadImg, res => {
                  wx.getImageInfo({
                    src: res,
                    success: function(res) {
                      canvas.save();
                      canvas.beginPath();

                      console.log(header_image_x, header_image_y, header_width, header_height, 'HeadImg');
                      console.log(circle_x, circle_y, circle_r, 'circle');

                      canvas.arc(circle_x, circle_y, circle_r, 0, 2 * Math.PI, false)
                      canvas.clip();
                      canvas.drawImage(res.path, header_image_x, header_image_y, header_width, header_height);
                      canvas.restore();

                      canvas.draw(false, () => {
                        wx.canvasToTempFilePath({
                          x: 0,
                          y: 0,
                          width: 750,
                          height: 1334,
                          canvasId: 'myCanvas',
                          fileType: 'jpg',
                          success: (res) => {
                            let pic = res.tempFilePath;

                            wx.saveImageToPhotosAlbum({
                              filePath: pic,
                              success(res) {
                                request.wxCheckSess().then(res => {
                                  let jwtobj = wx.getStorageSync('jwtobj');
                                  request.getToken().then((jwtobj) => {
                                    wx.uploadFile({
                                      url: rurl.serviceAdd + 'freelancer/upload-poster', //仅为示例，非真实的接口地址
                                      filePath: pic,
                                      name: 'file',
                                      formData: {
                                        project_type: posterObj.project_type
                                      },
                                      header: {
                                        Authorization: "Bearer " + jwtobj.access_token
                                      },
                                      success(res) {
                                        wx.showToast({
                                          title: '保存成功',
                                          icon: 'success',
                                          duration: 2000,
                                          mask: true
                                        });
                                        let Timeout = setTimeout(() => {
                                          _this.setData({
                                            hasSave: false
                                          })
                                          clearTimeout(Timeout)
                                        }, 2000)

                                      },
                                      fail: error => {
                                        wx.hideLoading();
                                        wx.showToast({
                                          title: '保存失败',
                                          icon: 'none',
                                          duration: 2000,
                                          mask: true
                                        });
                                        _this.setData({
                                          hasSave: false
                                        })
                                      }
                                    })
                                  })
                                }).catch()
                              },
                              fail: error => {
                                console.log(error)
                                _this.setData({
                                  hasSave: false
                                })
                                wx.hideLoading();
                                wx.showToast({
                                  title: '取消保存',
                                  icon: 'none',
                                  duration: 2000,
                                  mask: true
                                });
                              }
                            });

                          },
                          fail: res => {
                            console.log(res);
                            wx.hideLoading()
                          }
                        });
                      });

                    },
                    fail: res => {
                      console.log(res);
                      wx.hideLoading()
                    }
                  })
                })


              },
              fail: res => {
                console.log(res);
                wx.hideLoading()
              }
            })
          });
        },
        fail: res => {
          console.log(res);
          wx.hideLoading()
        }
      })
      // canvas.drawImage(QRCode, image_x, image_y, width, height);
    }
  }
```


# 效果如下：

![](/images/2020-07-06_113739.gif)